name: Code Web App CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  STACK_PATH: /home/mi/docker/stacks/kod

jobs:
  # Test job - runs on all branches and PRs
  test:
    runs-on: [self-hosted, homelab]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Verify server syntax
        run: node -c server/app.js

  # Deploy job - only runs on main after tests pass
  deploy:
    runs-on: [self-hosted, homelab]
    needs: test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4

      - name: Create directories
        run: |
          mkdir -p $STACK_PATH
          mkdir -p $STACK_PATH/public
          mkdir -p $STACK_PATH/server

      - name: Deploy to server
        run: |
          # Copy stack file and configuration
          cp kod.yml Dockerfile .dockerignore package.json $STACK_PATH/

          # Copy application files
          cp public/index.html $STACK_PATH/public/
          cp server/app.js $STACK_PATH/server/

          # Copy GitHub workflow
          cp -r .github $STACK_PATH/

          # Build and deploy
          cd $STACK_PATH
          docker compose -f kod.yml up -d --build

      - name: Verify deployment
        run: |
          sleep 10
          docker ps --filter name=kod
          curl -s http://localhost:3000/api/health || echo "Health check pending..."